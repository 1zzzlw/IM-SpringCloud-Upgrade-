<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zzzlew.mapper.ConversationMapper">

    <select id="selectList"
            resultType="com.zzzlew.pojo.entity.Conversation">
        select *
        from conversation c
        <where>
            -- 必要查条件
            c.user_id = #{userId}
            and c.status = 1
            <if test="quitTime != null and quitTime != ''">
                -- 如果用户退出时间非空
                and c.update_time >= #{quitTime}
            </if>
        </where>
    </select>

    <update id="updateConversationStatus">
        update conversation
        set latest_msg      = #{content},
            latest_msg_time = #{sendTime},
            status          = 1,
            unread_count    = case
                -- 对方的消息数量加1，发送者的消息数量还是原来的
                                  when user_id = #{receiverId}
                                      then unread_count + 1
                                  else unread_count
                end
        where id = #{conversationId}
    </update>

    <update id="updateGroupConversationStatus">
        update conversation
        set latest_msg = #{content},
        latest_msg_time = #{sendTime},
        status = 1,
        unread_count =
        case
        when user_id in
        <foreach collection="receiverIds" item="receiverId" open="(" close=")"
                 separator=",">
            #{receiverId}
        </foreach>
        then unread_count + 1
        else unread_count
        end
        where id = #{conversationId}
    </update>

    <select id="selectGroupMemberListByConversationId"
            resultType="com.zzzlew.pojo.vo.user.GroupMemberVO"
            parameterType="java.lang.String">
        select gm.user_id, gm.role, ua.username, ua.avatar
        from group_member gm
                 join user_auth ua on gm.user_id =
                                      ua.user_id
        where gm.group_id = #{conversationId}
    </select>

    <insert id="insertConversation">
        insert into conversation (id, user_id, target_id, type)
        values (#{conversationId}, #{toUserId}, #{fromUserId}, #{type})
    </insert>


</mapper>